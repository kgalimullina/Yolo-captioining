# -*- coding: utf-8 -*-
"""flower_app.

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1jNd0iCJLspVf3UTu1xqccwkXTGLVHReM
"""

import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from PIL import Image
import cv2
import os

import streamlit as st
import cv2
import numpy as np
from PIL import Image
import tempfile
import os
from ultralytics import YOLO

# –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ YOLO
@st.cache_resource
def load_model():
    return YOLO("best.pt")  # –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –≤–∞—à–µ–π –º–æ–¥–µ–ª–∏

model = load_model()

# –ü–æ–ª–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø–æ —É—Ö–æ–¥—É –∑–∞ —Ü–≤–µ—Ç–∞–º–∏
flower_care_db = {
    "bellflower": {
        "name": "–ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫",
        "water": "üíß –£–º–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–ª–∏–≤ (–ø–æ—á–≤–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–ª–µ–≥–∫–∞ –≤–ª–∞–∂–Ω–æ–π)",
        "light": "‚õÖ –ü–æ–ª—É—Ç–µ–Ω—å –∏–ª–∏ —Ä–∞—Å—Å–µ—è–Ω–Ω—ã–π —Å–≤–µ—Ç",
        "tips": "üå± –†–∞–∑–º–Ω–æ–∂–∞–µ—Ç—Å—è –¥–µ–ª–µ–Ω–∏–µ–º –∫—É—Å—Ç–∞\nüå∏ –¶–≤–µ—Ç–µ—Ç —Å –∏—é–Ω—è –ø–æ —Å–µ–Ω—Ç—è–±—Ä—å"
    },
    "black-eyed susan": {
        "name": "–†—É–¥–±–µ–∫–∏—è",
        "water": "üíß –ó–∞—Å—É—Ö–æ—É—Å—Ç–æ–π—á–∏–≤–∞, –ø–æ–ª–∏–≤ 1 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é",
        "light": "‚òÄÔ∏è –ü–æ–ª–Ω–æ–µ —Å–æ–ª–Ω—Ü–µ",
        "tips": "‚úÇÔ∏è –û–±—Ä–µ–∑–∞–π—Ç–µ —É–≤—è–¥—à–∏–µ —Ü–≤–µ—Ç—ã –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–µ–Ω–∏—è\nüîÑ –ú–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏–∫, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –¥–µ–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 3-4 –≥–æ–¥–∞"
    },
    "calendula": {
        "name": "–ö–∞–ª–µ–Ω–¥—É–ª–∞",
        "water": "üíß –ü–æ–ª–∏–≤ 2-3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é",
        "light": "‚òÄÔ∏è –°–æ–ª–Ω–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ",
        "tips": "üåø –õ–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ\nüå∏ –¶–≤–µ—Ç–µ—Ç —Å –∏—é–Ω—è –¥–æ –∑–∞–º–æ—Ä–æ–∑–∫–æ–≤"
    },
    "california poppy": {
        "name": "–≠—à—à–æ–ª—å—Ü–∏—è",
        "water": "üíß –û—á–µ–Ω—å —É–º–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–ª–∏–≤",
        "light": "‚òÄÔ∏è –ü–æ–ª–Ω–æ–µ —Å–æ–ª–Ω—Ü–µ",
        "tips": "üåº –¶–≤–µ—Ç—ã –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ –ø–∞—Å–º—É—Ä–Ω—É—é –ø–æ–≥–æ–¥—É\nüå± –°–∞–º–æ—Å–µ–µ—Ç—Å—è"
    },
    "carnation": {
        "name": "–ì–≤–æ–∑–¥–∏–∫–∞",
        "water": "üíß –ü–æ–ª–∏–≤ –ø–æ–¥ –∫–æ—Ä–µ–Ω—å, –∏–∑–±–µ–≥–∞—è –ª–∏—Å—Ç—å–µ–≤",
        "light": "‚òÄÔ∏è –Ø—Ä–∫–æ–µ —Å–æ–ª–Ω—Ü–µ",
        "tips": "üå°Ô∏è –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç –ø—Ä–æ—Ö–ª–∞–¥–Ω—ã–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã\n‚úÇÔ∏è –†–µ–≥—É–ª—è—Ä–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —É–≤—è–¥—à–∏—Ö —Ü–≤–µ—Ç–æ–≤"
    },
    "daffodil": {
        "name": "–ù–∞—Ä—Ü–∏—Å—Å",
        "water": "üíß –û–±–∏–ª—å–Ω—ã–π –ø–æ–ª–∏–≤ –≤–æ –≤—Ä–µ–º—è —Ä–æ—Å—Ç–∞",
        "light": "‚õÖ –ü–æ–ª—É—Ç–µ–Ω—å –∏–ª–∏ —Å–æ–ª–Ω—Ü–µ",
        "tips": "üå∑ –õ—É–∫–æ–≤–∏—á–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ\nüí§ –ü–æ—Å–ª–µ —Ü–≤–µ—Ç–µ–Ω–∏—è –Ω–µ –æ–±—Ä–µ–∑–∞–π—Ç–µ –ª–∏—Å—Ç—å—è 6 –Ω–µ–¥–µ–ª—å"
    },
    "daisy": {
        "name": "–†–æ–º–∞—à–∫–∞",
        "water": "üíß –†–µ–≥—É–ª—è—Ä–Ω—ã–π –ø–æ–ª–∏–≤",
        "light": "‚òÄÔ∏è –ü–æ–ª–Ω–æ–µ —Å–æ–ª–Ω—Ü–µ",
        "tips": "üå± –†–∞–∑–º–Ω–æ–∂–∞–µ—Ç—Å—è –¥–µ–ª–µ–Ω–∏–µ–º –∫—É—Å—Ç–∞\nüå∏ –°—Ä–µ–∑–∞–Ω–Ω—ã–µ —Ü–≤–µ—Ç—ã –¥–æ–ª–≥–æ —Å—Ç–æ—è—Ç –≤ –≤–æ–¥–µ"
    },
    "dandelion": {
        "name": "–û–¥—É–≤–∞–Ω—á–∏–∫",
        "water": "üíß –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª–∏–≤–∞",
        "light": "‚òÄÔ∏è/‚õÖ –õ—é–±–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ",
        "tips": "üåø –°—ä–µ–¥–æ–±–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ (–ª–∏—Å—Ç—å—è –¥–ª—è —Å–∞–ª–∞—Ç–æ–≤)\n‚ö†Ô∏è –ú–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —Å–æ—Ä–Ω—è–∫–æ–º"
    },
    "iris": {
        "name": "–ò—Ä–∏—Å",
        "water": "üíß –£–º–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–ª–∏–≤",
        "light": "‚òÄÔ∏è –°–æ–ª–Ω–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ",
        "tips": "üå± –ö–æ—Ä–Ω–µ–≤–∏—â–∞ –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥–ª—É–±–ª–µ–Ω—ã\n‚úÇÔ∏è –û–±—Ä–µ–∑–∫–∞ –ø–æ—Å–ª–µ —Ü–≤–µ—Ç–µ–Ω–∏—è"
    },
    "magnolia": {
        "name": "–ú–∞–≥–Ω–æ–ª–∏—è",
        "water": "üíß –ì–ª—É–±–æ–∫–∏–π –ø–æ–ª–∏–≤ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é",
        "light": "‚òÄÔ∏è –ü–æ–ª–Ω–æ–µ —Å–æ–ª–Ω—Ü–µ",
        "tips": "üå≥ –î–µ—Ä–µ–≤–æ, —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞\nüå∏ –ê—Ä–æ–º–∞—Ç–Ω—ã–µ —Ü–≤–µ—Ç—ã —Ä–∞–Ω–Ω–µ–π –≤–µ—Å–Ω–æ–π"
    },
    "rose": {
        "name": "–†–æ–∑–∞",
        "water": "üíß –ì–ª—É–±–æ–∫–∏–π –ø–æ–ª–∏–≤ 2-3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é",
        "light": "‚òÄÔ∏è –ü–æ–ª–Ω–æ–µ —Å–æ–ª–Ω—Ü–µ (6+ —á–∞—Å–æ–≤ –≤ –¥–µ–Ω—å)",
        "tips": "‚úÇÔ∏è –û–±—Ä–µ–∑–∫–∞ –≤–µ—Å–Ω–æ–π\nüêõ –†–µ–≥—É–ª—è—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç –≤—Ä–µ–¥–∏—Ç–µ–ª–µ–π"
    },
    "sunflower": {
        "name": "–ü–æ–¥—Å–æ–ª–Ω—É—Ö",
        "water": "üíß –û–±–∏–ª—å–Ω—ã–π –ø–æ–ª–∏–≤, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ –∑–∞—Å—É—Ö—É",
        "light": "‚òÄÔ∏è –ü–æ–ª–Ω–æ–µ —Å–æ–ª–Ω—Ü–µ",
        "tips": "üåª –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –∫ —Å–æ–ª–Ω—Ü—É\nüå± –û–¥–Ω–æ–ª–µ—Ç–Ω–µ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ"
    },
    "tulip": {
        "name": "–¢—é–ª—å–ø–∞–Ω",
        "water": "üíß –£–º–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–ª–∏–≤",
        "light": "‚òÄÔ∏è –°–æ–ª–Ω–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ",
        "tips": "üå∑ –õ—É–∫–æ–≤–∏—Ü—ã –≤—ã–∫–∞–ø—ã–≤–∞—é—Ç –ø–æ—Å–ª–µ —É–≤—è–¥–∞–Ω–∏—è –ª–∏—Å—Ç—å–µ–≤\n‚ùÑÔ∏è –¢—Ä–µ–±—É–µ—Ç –ø–µ—Ä–∏–æ–¥–∞ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è"
    },
    "water lily": {
        "name": "–ö—É–≤—à–∏–Ω–∫–∞",
        "water": "üíß –í–æ–¥–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ (–≥–ª—É–±–∏–Ω–∞ 30-60 —Å–º)",
        "light": "‚òÄÔ∏è –ü–æ–ª–Ω–æ–µ —Å–æ–ª–Ω—Ü–µ",
        "tips": "üêü –•–æ—Ä–æ—à–æ —É–∂–∏–≤–∞–µ—Ç—Å—è —Å —Ä—ã–±–∞–º–∏\n‚ùÑÔ∏è –ó–∏–º–æ—Å—Ç–æ–π–∫–∏–µ —Å–æ—Ä—Ç–∞ –≤—ã–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∑–∞–º–µ—Ä–∑–∞–Ω–∏–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏"
    }
}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
st.set_page_config(page_title="FlowerCare", page_icon="üå∏")
st.title("üå∏ FlowerCare: –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å —Ü–≤–µ—Ç–æ–≤")
st.markdown("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ —Ü–≤–µ—Ç–∫–∞ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —É—Ö–æ–¥—É")

# –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
uploaded_file = st.file_uploader("–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...", type=["jpg", "png", "jpeg"])

if uploaded_file is not None:
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    image = Image.open(uploaded_file)
    img_array = np.array(image)
    img_cv = cv2.cvtColor(img_array, cv2.COLOR_RGB2BGR)

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è YOLO
    with tempfile.NamedTemporaryFile(delete=False, suffix=".jpg") as tmp:
        tmp_path = tmp.name
        cv2.imwrite(tmp_path, img_cv)

    # –î–µ—Ç–µ–∫—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
    with st.spinner("üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ü–≤–µ—Ç–æ–∫..."):
        results = model.predict(tmp_path, conf=0.5)
        result = results[0]

    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    if len(result.boxes) > 0:
        # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è bounding boxes
        res_plotted = result.plot()[:, :, ::-1]
        st.image(res_plotted, caption="–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–µ—Ç–µ–∫—Ü–∏–∏", use_column_width=True)

        # –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–µ—Ç–µ–∫—Ü–∏—è—Ö
        detected_flowers = []
        confidence_scores = []

        for box in result.boxes:
            class_id = int(box.cls)
            class_name = model.names[class_id]
            detected_flowers.append(class_name.lower())
            confidence_scores.append(float(box.conf))

        # –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
        unique_detections = sorted(
            set(zip(detected_flowers, confidence_scores)),
            key=lambda x: x[1],
            reverse=True
        )

        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        st.subheader("üåø –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Ö–æ–¥—É")

        for flower, confidence in unique_detections:
            if flower in flower_care_db:
                care = flower_care_db[flower]
                with st.expander(f"**{care['name']}** (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {confidence:.2f})"):
                    st.markdown(f"""
                    **–ü–æ–ª–∏–≤:**
                    {care['water']}

                    **–û—Å–≤–µ—â–µ–Ω–∏–µ:**
                    {care['light']}

                    **–°–æ–≤–µ—Ç—ã –ø–æ —É—Ö–æ–¥—É:**
                    {care['tips']}
                    """)

                    # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–≤–µ—Ç–∫–∞
                    st.image(f"images/{flower}.jpg", width=200)
            else:
                st.warning(f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —É—Ö–æ–¥—É –¥–ª—è '{flower}' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ")

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        st.markdown(f"**–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ü–≤–µ—Ç–æ–≤:** {len(detected_flowers)}")
        st.markdown(f"**–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:** {np.mean(confidence_scores):.2f}")
    else:
        st.warning("–¶–≤–µ—Ç—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.")

    # –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    os.unlink(tmp_path)
else:
    st.info("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–≤–µ—Ç–∫–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")

# –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
st.sidebar.header("–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏")
st.sidebar.info("""
**FlowerCare 2.0**
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç 14 –≤–∏–¥–æ–≤ —Ü–≤–µ—Ç–æ–≤:
- –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫
- –†—É–¥–±–µ–∫–∏—è
- –ö–∞–ª–µ–Ω–¥—É–ª–∞
- –≠—à—à–æ–ª—å—Ü–∏—è
- –ì–≤–æ–∑–¥–∏–∫–∞
- –ù–∞—Ä—Ü–∏—Å—Å
- –†–æ–º–∞—à–∫–∞
- –û–¥—É–≤–∞–Ω—á–∏–∫
- –ò—Ä–∏—Å
- –ú–∞–≥–Ω–æ–ª–∏—è
- –†–æ–∑–∞
- –ü–æ–¥—Å–æ–ª–Ω—É—Ö
- –¢—é–ª—å–ø–∞–Ω
- –ö—É–≤—à–∏–Ω–∫–∞

–ò –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Ö–æ–¥—É.
""")